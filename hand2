<#
.SYNOPSIS
    Replaces IIS handler mappings found inside <location path=""> of applicationHost.config.
.DESCRIPTION
    Backs up the config, removes all <add> entries under <location path=""]/system.webServer/handlers,
    injects new ones from a <collection>, and restarts IIS.
#>

param (
    [Parameter(Mandatory = $true)]
    [string]$HandlerXmlPath
)
Import-Module WebAdministration
$hostConfigPath = "$env:SystemRoot\System32\inetsrv\config\applicationHost.config"
$backupPath = "$hostConfigPath.bak_" + (Get-Date -Format "yyyyMMdd_HHmmss")

if (-not (Test-Path $HandlerXmlPath)) {
    Write-Error "Handler XML input file not found: $HandlerXmlPath"
    exit 1
}

if (-not (Test-Path $hostConfigPath)) {
    Write-Error "applicationHost.config not found at expected path: $hostConfigPath"
    exit 1
}

Write-Host "Backing up applicationHost.config to $backupPath..."
Copy-Item -Path $hostConfigPath -Destination $backupPath -Force

# Load XML
[xml]$hostConfig = Get-Content $hostConfigPath
[xml]$importXml = Get-Content $HandlerXmlPath

# Locate <handlers> inside <location path="">
$handlersNode = $hostConfig.SelectSingleNode("//location[@path='']/system.webServer/handlers")

if (-not $handlersNode) {
    Write-Error "No <handlers> section found under <location path=''>."
    exit 1
}

Write-Host "Clearing existing handler mappings..."
$handlers = Get-WebConfiguration -Filter "/system.webServer/handlers/*"
foreach ($h in $handlers) {
    Remove-WebConfigurationProperty -Filter "/system.webServer/handlers" -Name "." -AtElement @{name=$h.name}
    Write-Host "Removed handler: $($h.name)"
}

# Inject new <add> entries
Write-Host "Importing new handlers..."
foreach ($handler in $importXml.collection.add) {
    $importedNode = $hostConfig.ImportNode($handler, $true)
    $handlersNode.AppendChild($importedNode) | Out-Null
    Write-Host "Injected: $($handler.name)"
}

# Save changes and restart IIS
$hostConfig.Save($hostConfigPath)

Write-Host "applicationHost.config updated successfully. Restarting IIS..."
iisreset
